
<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Furettogotchi - BitLove</title>
    
    <!-- STYLES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Press Start 2P', monospace;
        background-color: #2d2d2d;
        touch-action: manipulation;
        overflow: hidden; /* Prevent scrolling on body */
        user-select: none;
      }
      /* Custom Scrollbar */
      ::-webkit-scrollbar { width: 4px; }
      ::-webkit-scrollbar-track { background: #9ea792; }
      ::-webkit-scrollbar-thumb { background: #4a5043; }
      
      .text-shadow-glow {
        text-shadow: 0 0 10px rgba(255,182,193,0.5), 0 0 20px rgba(255,182,193,0.3);
      }
      .marquee {
        display: inline-block;
        animation: scroll-left 10s linear infinite;
      }
      @keyframes scroll-left {
        0% { transform: translateX(100%); }
        100% { transform: translateX(-100%); }
      }
      .rendering-pixelated {
        image-rendering: pixelated;
      }
      
      /* Safe area for mobile */
      .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
      .animate-spin-slow { animation: spin 4s linear infinite; }
      @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>

    <!-- BABEL STANDALONE FOR BROWSER JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- REACT IMPORTS MAP -->
    <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@18.2.0",
    "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
    "lucide-react": "https://esm.sh/lucide-react@0.294.0",
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "react/": "https://esm.sh/react@^19.2.3/"
  }
}
</script>
  </head>
  <body>
    <div id="root"></div>

    <!-- MAIN APP SCRIPT -->
    <script type="text/babel" data-type="module">
      import React, { useState, useEffect, useRef } from 'react';
      import ReactDOM from 'react-dom/client';
      import { 
        Utensils, Zap, Heart, Trash2, Moon, MessageSquare, 
        Battery, Coffee, Smile, ChevronUp, ChevronDown,
        Play, Pause, SkipForward, Music, AlertCircle, MapPin
      } from 'lucide-react';

      // --- CONSTANTS & TYPES ---

      const USER_NAME = "Tilde";
      const AUDIO_BASE = "https://micmer-git.github.io/audio/";

      const GameState = {
        IDLE: 'IDLE',
        EATING: 'EATING',
        SLEEPING: 'SLEEPING',
        POOPING: 'POOPING',
        DEAD: 'DEAD',
        PLAYING: 'PLAYING',
        YOGA: 'YOGA'
      };

      const Location = {
        BERGAMO: 'BERGAMO',
        GREECE: 'GREECE',
        VILLA_PANZA: 'VILLA_PANZA',
        INDIA: 'INDIA'
      };

      const INITIAL_STATS = {
        hunger: 100,
        happiness: 50,
        caffeine: 80,
        relax: 50,
        poopCount: 0
      };

      const FULL_PLAYLIST = [
        { title: 'Nevada', artist: 'Kerala Dust', src: `${AUDIO_BASE}nevada.mp3` },
        { title: 'Closer', artist: 'Kerala Dust', src: `${AUDIO_BASE}closer.mp3` },
        { title: 'Verticale', artist: 'Faccianuvola', src: `${AUDIO_BASE}faccianuvola_verticale.mp3` },
        { title: 'Primavera', artist: 'Faccianuvola', src: `${AUDIO_BASE}faccianuvola_primavera.mp3` },
        { title: 'Albero', artist: 'Eugenio in Via Di Gioia', src: `${AUDIO_BASE}albero.mp3` },
        { title: 'Mantra', artist: 'Spiritual Eye', src: `${AUDIO_BASE}india.mp3` }
      ];

      const QUOTES = [
        { text: "Tilde, tutto questo √® per te.", source: "System", category: "system" },
        { text: "Tilde, il server √® freddo stasera.", source: "Furetto", category: "system" },
        { text: "Ciao Tilde, sei reale o sei un render?", source: "Furetto", category: "system" },
        { text: "Voglio andare altrove...", source: "Furetto", category: "system" },

        // Faccianuvola with references
        { text: "Disperata giovent√π non vuol tornare a casa sua.", source: "Faccianuvola", category: "faccianuvola", reference: "Disperata Giovent√π" },
        { text: "Restiamo perpendicolari al mondo che ci guarda storto.", source: "Faccianuvola", category: "faccianuvola", reference: "Verticale" },
        { text: "Non avremo pi√π paura di rincorrerci per gioco.", source: "Faccianuvola", category: "faccianuvola", reference: "Primavera" },
        { text: "Torner√≤ sulle mie impronte soltanto per non perdermi.", source: "Faccianuvola", category: "faccianuvola", reference: "Primavera" },
        { text: "Passeranno giorni e settimane tra le nuvole.", source: "Faccianuvola", category: "faccianuvola", reference: "Verticale" },
        { text: "Acqua sotto al ponte, prima o poi sar√≤ di nuovo da te.", source: "Faccianuvola", category: "faccianuvola", reference: "Albero" },
        { text: "C'era una frase che ti dovevo dire.", source: "Faccianuvola", category: "faccianuvola", reference: "Disperata Giovent√π" },
        { text: "Mi piacerebbe incontrarti dove il mio cielo finisce.", source: "Faccianuvola", category: "faccianuvola", reference: "Verticale" },
        { text: "E il tempo scorre all'ins√π.", source: "Faccianuvola", category: "faccianuvola", reference: "Verticale" },
        { text: "Il nostro amore era un singhiozzo della dolce ingenuit√†.", source: "Faccianuvola", category: "faccianuvola", reference: "Primavera" },
        { text: "Un giorno che era gi√† finito e che mai pi√π ritorner√†.", source: "Faccianuvola", category: "faccianuvola", reference: "Primavera" },
        { text: "Poi tu scendi dalla luna.", source: "Faccianuvola", category: "faccianuvola", reference: "Disperata Giovent√π" },
        { text: "Poi ti porto lungo il fiume e ti grido che ti amo.", source: "Faccianuvola", category: "faccianuvola", reference: "Albero" },
        { text: "Parler√≤ di te come dei vestiti che mettevo per dormire.", source: "Faccianuvola", category: "faccianuvola", reference: "Verticale" },
        { text: "Come una storia che non voglio raccontare.", source: "Faccianuvola", category: "faccianuvola", reference: "Disperata Giovent√π" },
        { text: "Un uccellino sul sentiero mi sussurra: non √® vero che non tornerai.", source: "Faccianuvola", category: "faccianuvola", reference: "Primavera" },
        { text: "Mi ricorder√≤ di noi come due bambini che giocavano alle corse.", source: "Faccianuvola", category: "faccianuvola", reference: "Albero" },
        { text: "A nascondino nelle vigne o sotto a un ponte.", source: "Faccianuvola", category: "faccianuvola", reference: "Verticale" },
        { text: "Vorrei un'ora come prima, degli occhi da bambina.", source: "Faccianuvola", category: "faccianuvola", reference: "Primavera" },
        { text: "Vorrei la luna piena e delle mani con cui toccarla ancora.", source: "Faccianuvola", category: "faccianuvola", reference: "Verticale" },
        { text: "Il vento del mattino mi sveglia nei sogni in cui non ci sei.", source: "Faccianuvola", category: "faccianuvola", reference: "Disperata Giovent√π" },
        { text: "Ci prenderemo per la mano e torneremo piano piano.", source: "Faccianuvola", category: "faccianuvola", reference: "Albero" },
        { text: "Non ricordi il giorno in cui gridammo alla felicit√†?", source: "Faccianuvola", category: "faccianuvola", reference: "Primavera" },
        { text: "Lunghi baci tra i cespugli.", source: "Faccianuvola", category: "faccianuvola", reference: "Verticale" },
        { text: "La faccia nella brina.", source: "Faccianuvola", category: "faccianuvola", reference: "Disperata Giovent√π" },
        
        { text: "The moon is a heavy thing to carry.", source: "Kerala Dust", category: "kerala", reference: "Nevada" },
        { text: "üéµ Shake off the dust... üéµ", source: "Kerala Dust", category: "kerala", reference: "Closer" },

        { text: "La luce di Dan Flavin cambia il mio colore.", source: "Villa Panza", category: "panza" },
        { text: "Neon vibes only.", source: "Villa Panza", category: "panza" }
      ];

      // --- COMPONENTS ---

      const MusicPlayer = ({ playlist, theme }) => {
        const [isPlaying, setIsPlaying] = useState(false);
        const [currentTrackIndex, setCurrentTrackIndex] = useState(0);
        const [error, setError] = useState(false);
        const audioRef = useRef(null);
        
        const currentTrack = playlist[currentTrackIndex % playlist.length];

        useEffect(() => {
          const attemptAutoplay = async () => {
            if (audioRef.current) {
                try {
                await audioRef.current.play();
                setIsPlaying(true);
                } catch (err) {
                console.warn("Autoplay blocked by browser policy:", err);
                setIsPlaying(false);
                }
            }
          };
          attemptAutoplay();
        }, []);

        useEffect(() => {
          if (audioRef.current && currentTrack) {
            audioRef.current.src = currentTrack.src;
            audioRef.current.load();
            setError(false);
            if (isPlaying) {
              audioRef.current.play().catch(e => {
                  console.warn("Playback prevented");
                  setIsPlaying(false);
              });
            }
          }
        }, [currentTrack, isPlaying]);

        const nextTrack = () => setCurrentTrackIndex((prev) => (prev + 1) % playlist.length);
        const handleError = () => { setError(true); setTimeout(nextTrack, 2000); };
        
        const borderColor = theme?.shell?.split(' ')[1] || 'border-neutral-700';
        const marqueeColor = theme?.highlight?.replace('text-', 'text-') || 'text-green-400';

        return (
          <>
            <audio ref={audioRef} onEnded={nextTrack} onError={handleError} />
            
            {/* DESKTOP VIEW */}
            <div className={`hidden md:flex mt-4 w-full max-w-[320px] bg-neutral-900 border-4 ${borderColor} rounded-xl p-4 flex-col gap-3 shadow-2xl relative overflow-hidden transition-colors duration-700`}>
              <div className="absolute top-[-10px] right-[-10px] opacity-10 pointer-events-none">
                  <div className={`w-24 h-24 rounded-full border-8 border-dashed border-white ${isPlaying ? 'animate-spin' : ''}`} style={{animationDuration: '4s'}}></div>
              </div>
              <div className="bg-black/50 rounded p-2 border border-white/10 flex items-center justify-between text-xs font-mono z-10">
                  <div className={`flex items-center gap-2 overflow-hidden whitespace-nowrap w-full ${marqueeColor}`}>
                  {error ? <AlertCircle size={14} className="text-red-500 shrink-0" /> : <Music size={14} className={`shrink-0 ${isPlaying ? "animate-pulse" : ""}`} />}
                  <div className="w-full overflow-hidden relative">
                      <span className="marquee block uppercase tracking-wider">
                          {error ? `ERR: ${currentTrack.src}` : `${currentTrack.artist} - ${currentTrack.title}`}
                      </span>
                  </div>
                  </div>
              </div>
              <div className="flex justify-center gap-8 z-10">
                  <button onClick={() => setIsPlaying(!isPlaying)} className="text-neutral-500 hover:text-white active:scale-95 transition-all transform hover:scale-110">
                  {isPlaying ? <Pause size={32} fill="currentColor" /> : <Play size={32} fill="currentColor" />}
                  </button>
                  <button onClick={nextTrack} className="text-neutral-500 hover:text-white active:scale-95 transition-all transform hover:scale-110">
                  <SkipForward size={32} fill="currentColor" />
                  </button>
              </div>
            </div>

            {/* MOBILE VIEW: Ultra Compact Bottom Pill */}
            <div className="md:hidden fixed bottom-0 left-0 right-0 h-12 bg-black/90 backdrop-blur-md border-t border-white/10 flex items-center px-4 justify-between z-50 pb-safe">
              <div className="flex items-center gap-2 overflow-hidden flex-1 mr-2">
                  <div className={`w-6 h-6 rounded-full bg-neutral-800 flex items-center justify-center border border-white/10 shrink-0 ${isPlaying ? 'animate-spin-slow' : ''}`}>
                    <Music size={10} className={marqueeColor} />
                  </div>
                  <div className="flex flex-col overflow-hidden leading-none">
                    <span className={`text-[9px] uppercase font-bold truncate ${marqueeColor}`}>{currentTrack.title}</span>
                    <span className="text-[8px] text-neutral-500 truncate">{currentTrack.artist}</span>
                  </div>
              </div>
              <div className="flex items-center gap-4 shrink-0">
                  <button onClick={() => setIsPlaying(!isPlaying)} className="text-white active:scale-90 transition-transform">
                    {isPlaying ? <Pause size={20} fill="currentColor" /> : <Play size={20} fill="currentColor" />}
                  </button>
                  <button onClick={nextTrack} className="text-white active:scale-90 transition-transform">
                    <SkipForward size={20} fill="currentColor" />
                  </button>
              </div>
            </div>
          </>
        );
      };

      const PixelFerret = ({ state, frame }) => {
        const C = '#FFFDD0'; const D = '#5C4033'; const B = '#000000'; const P = '#FFB6C1'; const G = '#556B2F'; const T = 'transparent';
        const renderPixels = (pixels) => pixels.map((row, y) => row.split('').map((c, x) => {
            let fill = T; if(c==='C') fill=C; if(c==='D') fill=D; if(c==='B') fill=B; if(c==='P') fill=P; if(c==='G') fill=G;
            return fill !== T ? <rect key={`${x}-${y}`} x={x} y={y} width={1} height={1} fill={fill} /> : null;
        }));
        const idle1 = ["TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTDDTTTTTTDDTTT","TTDCCDDTTDDCCDTT","TTDCCCCCCCCCCDTT","TTDCCCCCCCCCCDTT","TTDCBDCCCCBDCDTT","TTDCBDCCCCBDCDTT","TTDCCCCPPCCCCDTT","TTDCCCCDDCCCCDTT","TTTDCCCCCCCCDTTT","TTTTDDDDDDDDTTTT","TTTTTCCCCCCCTTTT","TTTTTDDCCDDTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT"];
        const idle2 = ["TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTDDTTTTTTDDTTT","TTDCCDDTTDDCCDTT","TTDCCCCCCCCCCDTT","TTDCCCCCCCCCCDTT","TTDCBDCCCCBDCDTT","TTDCBDCCCCBDCDTT","TTDCCCCPPCCCCDTT","TTDCCCCDDCCCCDTT","TTTDCCCCCCCCDTTT","TTTTDDDDDDDDTTTT","TTTTTDDCCDDTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT"];
        const eat1 = ["TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTDDTTTTTTDDTTT","TTDCCDDTTDDCCDTT","TTDCCCCCCCCCCDTT","TTDCBDCCCCBDCDTT","TTDCBDCCCCBDCDTT","TTDCCCCPPCCCCDTT","TTDCCCCDDCCCCDTT","TTTDCCCCCCCCDTTT","TTTTDDDDDDDDTTTT","TTTTTCCCCCCCTTTT","TTTTTDDCCDDTTGGT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT"];
        const eat2 = ["TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTDDTTTTTTDDTTT","TTDCCDDTTDDCCDTT","TTDCCCCCCCCCCDTT","TTDCBDCCCCBDCDTT","TTDCBDCCCCBDCDTT","TTDCCCCPPCCCCDTT","TTDCCCCDDCCCCDTT","TTTDCCCDDCCCDTTT","TTTTDDDDDDDDTTTT","TTTTTCCCCCCCTTTT","TTTTTDDCCDDTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT"];
        const dead = ["TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTDDTTTTTTDDTTT","TTDCCDDTTDDCCDTT","TTDCCCCCCCCCCDTT","TTDCXXCCCCXXCDTT","TTDCXXCCCCXXCDTT","TTDCCCCPPCCCCDTT","TTDCCCCDDCCCCDTT","TTTDCCCCCCCCDTTT","TTTTDDDDDDDDTTTT","TTTTTCCCCCCCTTTT","TTTTTDDCCDDTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT"];
        const sleep1 = ["TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTTTTZTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTDDTTTTTTDDTTT","TTDCCDDTTDDCCDTT","TTDCCCCCCCCCCDTT","TTDCCDDCCCDDCDTT","TTDCCCCCCCCCCDTT","TTDCCCCPPCCCCDTT","TTDCCCCDDCCCCDTT","TTTDCCCCCCCCDTTT","TTTTDDDDDDDDTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT"];
        const sleep2 = ["TTTTTTTTTTTTTTTT","TTTTZZZTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTDDTTTTTTDDTTT","TTDCCDDTTDDCCDTT","TTDCCCCCCCCCCDTT","TTDCCDDCCCDDCDTT","TTDCCCCCCCCCCDTT","TTDCCCCPPCCCCDTT","TTDCCCCDDCCCCDTT","TTTDCCCCCCCCDTTT","TTTTDDDDDDDDTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT"];
        const yoga1 = ["TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTDDTTTTTTDDTTT","TTDCCDDTTDDCCDTT","TTDCCCCCCCCCCDTT","TTDCCDDCCCDDCDTT","TTDCCCCCCCCCCDTT","TTDCCCCPPCCCCDTT","TTDCCCCDDCCCCDTT","TTTDCCCCCCCCDTTT","TTTTDCCCCCCDTTTT","TTTTDDDDDDDDTTTT","TTTTTTDDDDTTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT","TTTTTTTTTTTTTTTT"];
        
        let currentMap = idle1;
        if (state === GameState.DEAD) currentMap = dead;
        else if (state === GameState.EATING) currentMap = frame ? eat1 : eat2;
        else if (state === GameState.SLEEPING) currentMap = frame ? sleep1 : sleep2;
        else if (state === GameState.YOGA) currentMap = yoga1;
        else currentMap = frame ? idle1 : idle2;

        return <svg viewBox="0 0 16 16" className="w-full h-full rendering-pixelated" style={{imageRendering:'pixelated'}}>{renderPixels(currentMap)}</svg>;
      };

      // MAIN APP
      const App = () => {
        const [stats, setStats] = useState(INITIAL_STATS);
        const [gameState, setGameState] = useState(GameState.IDLE);
        const [menuState, setMenuState] = useState('IDLE');
        const [menuIndex, setMenuIndex] = useState(0);
        const [frame, setFrame] = useState(0);
        const [message, setMessage] = useState("");
        const [isMessageVisible, setIsMessageVisible] = useState(false);
        const [location, setLocation] = useState(Location.BERGAMO);
        const [interactionEmoji, setInteractionEmoji] = useState(null);
        const [showIntro, setShowIntro] = useState(true);
        const tickRef = useRef(null);

        const getMainOptions = () => ['CIBO', 'YOGA', 'PULISCI', 'LUCE', 'VIAGGIA'];
        const getFoodOptions = () => {
          switch (location) {
            case Location.GREECE: return ['Pita Gyros', 'Zuppa Oporto', 'Caff√® Sabbioso'];
            case Location.INDIA: return ['Dahl Patate', 'Palak Spinaci', 'Chai', 'Burro d\'arachidi Penny'];
            case Location.VILLA_PANZA: return ['Avocado', 'Uova e Pepe', 'Caff√®']; 
            default: return ['Avocado', 'Uova e Pepe', 'Caff√®', 'Bugan Pizza'];
          }
        };
        const getTravelOptions = () => ['BERGAMO', 'GRECIA', 'VILLA PANZA', 'INDIA'];

        const getCurrentPlaylist = () => {
          if (location === Location.GREECE) return FULL_PLAYLIST.filter(t => t.artist === 'Kerala Dust');
          else if (location === Location.INDIA) return FULL_PLAYLIST.filter(t => t.src.includes('india'));
          else if (location === Location.BERGAMO) return FULL_PLAYLIST.filter(t => t.artist === 'Faccianuvola' || t.artist.includes('Eugenio'));
          return FULL_PLAYLIST;
        };

        const getRandomQuote = () => {
          let allowedCategories = ['system'];
          if (location === Location.BERGAMO) allowedCategories.push('faccianuvola');
          if (location === Location.GREECE) allowedCategories.push('kerala');
          if (location === Location.VILLA_PANZA) allowedCategories.push('panza');
          const pool = QUOTES.filter(q => allowedCategories.includes(q.category));
          return pool[Math.floor(Math.random() * pool.length)];
        };

        const showQuote = (forcedQuote = null, duration = 6000) => {
          if (gameState === GameState.DEAD) return;
          let text = forcedQuote;
          if (!text) {
             const q = getRandomQuote();
             if (q.reference) text = `${q.text} (${q.reference})`;
             else if (q.text.includes('üéµ')) text = q.text;
             else if (Math.random() < 0.4 && q.category !== 'system') text = `${USER_NAME}, "${q.text.toLowerCase()}"`;
             else text = `"${q.text}"`;
          }
          setMessage(text);
          setIsMessageVisible(true);
          setTimeout(() => setIsMessageVisible(false), duration);
        };

        const triggerAnimation = (emoji) => {
          setInteractionEmoji(emoji);
          setTimeout(() => setInteractionEmoji(null), 2000);
        };

        useEffect(() => {
          tickRef.current = setInterval(() => {
            setFrame(f => (f === 0 ? 1 : 0));
            
            // Passive Comments
            if (gameState === GameState.IDLE && !isMessageVisible && !showIntro && Math.random() < 0.05) {
                showQuote();
            }

            if (gameState !== GameState.DEAD && !showIntro) {
              setStats(prev => {
                const newCaffeine = Math.max(0, prev.caffeine - 0.04);
                const newRelax = Math.max(0, prev.relax - 0.03);
                const newHunger = Math.max(0, prev.hunger - 0.02);
                
                let happinessDecay = 0.01;
                if (prev.relax < 20) happinessDecay += 0.02;
                if (prev.poopCount > 0) happinessDecay += 0.05;
                const newHappiness = Math.max(0, prev.happiness - happinessDecay);
                
                let newPoop = prev.poopCount;
                let poopChance = 0.001;
                if (location === Location.INDIA && prev.poopCount < 4) poopChance = 0.005;

                if (prev.hunger > 20 && Math.random() < poopChance && prev.poopCount < 4 && gameState !== GameState.SLEEPING && gameState !== GameState.YOGA) {
                  newPoop += 1;
                  if (location === Location.INDIA) showQuote("Devo trovare un bagno... subito.");
                }

                if (newHunger <= 0) {
                  setGameState(GameState.DEAD);
                  setMessage("System Failure. Fame.");
                  setIsMessageVisible(true);
                }

                if (gameState === GameState.YOGA && newRelax >= 100) {
                  setGameState(GameState.IDLE);
                  showQuote(`Namast√®, ${USER_NAME}.`);
                }
                
                return { hunger: newHunger, happiness: newHappiness, caffeine: newCaffeine, relax: newRelax, poopCount: newPoop };
              });
            }
          }, 1000);
          return () => clearInterval(tickRef.current);
        }, [gameState, isMessageVisible, location, showIntro]);

        const getCurrentMenuList = () => {
          switch (menuState) {
            case 'MAIN_MENU': return getMainOptions();
            case 'FOOD_MENU': return getFoodOptions();
            case 'TRAVEL_MENU': return getTravelOptions();
            default: return [];
          }
        };

        const handleUp = () => { if (gameState !== GameState.DEAD && !showIntro && getCurrentMenuList().length) setMenuIndex(p => (p - 1 + getCurrentMenuList().length) % getCurrentMenuList().length); };
        const handleDown = () => { if (gameState !== GameState.DEAD && !showIntro && getCurrentMenuList().length) setMenuIndex(p => (p + 1) % getCurrentMenuList().length); };

        const handleConfirm = () => {
          if (gameState === GameState.DEAD || showIntro) return;
          if (menuState === 'IDLE') { setMenuState('MAIN_MENU'); setMenuIndex(0); }
          else if (menuState === 'MAIN_MENU') {
            const selected = getMainOptions()[menuIndex];
            if (selected === 'CIBO') { setMenuState('FOOD_MENU'); setMenuIndex(0); }
            else if (selected === 'YOGA') startYoga();
            else if (selected === 'PULISCI') cleanPoop();
            else if (selected === 'LUCE') toggleSleep();
            else if (selected === 'VIAGGIA') { setMenuState('TRAVEL_MENU'); setMenuIndex(0); }
          }
          else if (menuState === 'FOOD_MENU') confirmFood(menuIndex);
          else if (menuState === 'TRAVEL_MENU') confirmTravel(menuIndex);
        };

        const handleBack = () => { if (gameState !== GameState.DEAD && !showIntro) { setMenuState('IDLE'); setMenuIndex(0); } };

        const confirmFood = (index) => {
          const foods = getFoodOptions();
          const selectedFood = foods[index];
          setMenuState('IDLE');
          setGameState(GameState.EATING);
          setTimeout(() => {
            setStats(prev => {
               let { caffeine, hunger, happiness, poopCount } = prev;
               if (selectedFood.includes('Caff√®')) { caffeine = Math.min(100, caffeine + 50); happiness += 2; triggerAnimation("‚òï"); showQuote(location === Location.GREECE ? "Caff√® sabbioso." : `Carburante.`); }
               else if (selectedFood.includes('Chai')) { caffeine = Math.min(100, caffeine + 40); happiness += 5; triggerAnimation("‚òï"); showQuote(`Come quello di casa.`); }
               else if (selectedFood.includes('Burro')) { hunger = Math.min(100, hunger + 60); happiness += 10; triggerAnimation("ü•ú"); showQuote(`Burro d'arachidi del Penny.`); }
               else if (selectedFood.includes('Avocado')) { hunger = Math.min(100, hunger + 40); happiness += 5; triggerAnimation("ü•ë"); showQuote(`Grassi buoni.`); }
               else if (selectedFood.includes('Bugan')) { hunger = Math.min(100, hunger + 80); happiness += 10; triggerAnimation("üçï"); showQuote(`Sant' Alessandro 31.`); }
               else if (selectedFood.includes('Dahl') || selectedFood.includes('Palak')) {
                 hunger = Math.min(100, hunger + 70); happiness += 8; triggerAnimation("ü•ò"); showQuote("Speziato.");
                 if (Math.random() < 0.4) { poopCount = Math.min(4, poopCount + 1); setTimeout(() => showQuote("Oh no... la pancia."), 2500); }
               }
               else if (selectedFood.includes('Lassi') || selectedFood.includes('Yogurt')) {
                 hunger = Math.min(100, hunger + 30); happiness += 10; poopCount = 0; triggerAnimation("ü•õ"); showQuote("Reset gastrico effettuato.");
               }
               else { hunger = Math.min(100, hunger + 50); happiness += 3; triggerAnimation("üç≥"); }
               return { ...prev, caffeine, hunger, happiness: Math.min(100, happiness), poopCount };
            });
            setGameState(GameState.IDLE);
          }, 2000);
        };

        const confirmTravel = (index) => {
          const destinations = [Location.BERGAMO, Location.GREECE, Location.VILLA_PANZA, Location.INDIA];
          const destination = destinations[index];
          setMenuState('IDLE');
          if (destination === location) { showQuote("Siamo gi√† qui."); return; }
          
          if (destination === Location.INDIA) {
             const unlock = new Date('2025-12-29');
             if (Date.now() < unlock.getTime()) {
                showQuote("L'attesa √® l'unica cosa che ci rimane. (2025)");
                return;
             }
          }

          setGameState(GameState.SLEEPING);
          setMessage(`Viaggio verso ${destination}...`);
          setIsMessageVisible(true);
          triggerAnimation("‚úàÔ∏è");
          
          setTimeout(() => {
            setLocation(destination);
            setGameState(GameState.IDLE);
            setIsMessageVisible(false);
            setStats(prev => ({ ...prev, happiness: 100 }));
            if (destination === Location.GREECE) showQuote("Kalimera, Tilde.");
            if (destination === Location.VILLA_PANZA) showQuote("Luci al neon.");
            if (destination === Location.INDIA) showQuote("Namaste. Attenzione all'acqua.");
            if (destination === Location.BERGAMO) showQuote("Casa.");
          }, 3000);
        };

        const startYoga = () => {
          setMenuState('IDLE');
          if (gameState === GameState.SLEEPING) return;
          setGameState(GameState.YOGA);
          const hour = new Date().getHours();
          const isEarly = hour < 9;
          
          if (location === Location.GREECE) {
            showQuote("Corsetta tra Renzo Piano e l'acropoli. üèõÔ∏èüèÉ", 6000);
            triggerAnimation("üèÉ");
          } else if (location === Location.INDIA) {
            showQuote("Erica non sopporta i fumi di Varanasi! üò§", 6000);
            triggerAnimation("üî•");
          } else {
            if (isEarly) showQuote("Sessione mattutina con Erica da Rovetta.", 4000);
            else showQuote("Yoga con Erica da Rovetta. Inspira...", 4000);
            triggerAnimation("üßò");
          }
          setStats(prev => ({ ...prev, relax: Math.min(100, prev.relax + 40) }));
        };

        const cleanPoop = () => {
          setMenuState('IDLE');
          if (stats.poopCount > 0) { setStats(prev => ({ ...prev, poopCount: 0, happiness: Math.min(100, prev.happiness + 10) })); triggerAnimation("‚ú®"); showQuote("Pulito."); }
          else { showQuote(`Tutto pulito.`); triggerAnimation("üëç"); }
        };

        const toggleSleep = () => {
          setMenuState('IDLE');
          if (gameState === GameState.SLEEPING) { setGameState(GameState.IDLE); showQuote("Sveglia."); triggerAnimation("‚òÄÔ∏è"); }
          else { setGameState(GameState.SLEEPING); triggerAnimation("üí§"); }
        };

        const getTheme = () => {
          if (location === Location.GREECE) return {
              bg: "bg-gradient-to-b from-sky-400 to-blue-600",
              shell: "bg-white border-[#0057B8]",
              shellShadow: "shadow-[0_20px_40px_rgba(0,87,184,0.4)]",
              inner: "bg-[#e0f7fa] border-[#0057B8]",
              textMain: "text-[#0057B8]",
              highlight: "text-blue-500",
              branding: "GRECIA 3000",
              flag: "üá¨üá∑"
          }; else if (location === Location.VILLA_PANZA) return {
              bg: "bg-neutral-950",
              shell: "bg-neutral-800 border-pink-500",
              shellShadow: "shadow-[0_0_30px_rgba(255,0,255,0.4)]",
              inner: "bg-black border-pink-500",
              textMain: "text-pink-500",
              highlight: "text-pink-400",
              branding: "NEON VILLA",
              flag: "üñºÔ∏è"
          }; else if (location === Location.INDIA) return {
              bg: "bg-gradient-to-br from-orange-500 via-amber-200 to-green-600",
              shell: "bg-orange-100 border-orange-600",
              shellShadow: "shadow-[0_20px_40px_rgba(234,88,12,0.5)]",
              inner: "bg-amber-50 border-orange-600",
              textMain: "text-orange-800",
              highlight: "text-green-600",
              branding: "‡§´‡•Å‡§∞‡•á‡§ü‡•ã‡§ó‡•ã‡§§‡•ç‡§ö‡•Ä",
              flag: "üáÆüá≥"
          };
          return {
            bg: "bg-gradient-to-br from-purple-900 to-indigo-900",
            shell: "bg-[#b8e0d2] border-[#e8f3d6]",
            shellShadow: "shadow-[inset_-5px_-5px_15px_rgba(0,0,0,0.1),_0_20px_40px_rgba(0,0,0,0.6)]",
            inner: "bg-[#fcfc9c] border-[#95c556]",
            textMain: "text-[#4a5043]",
            highlight: "text-[#95c556]",
            branding: "FURETTOGOTCHI",
            flag: "ü•ë"
          };
        };

        const theme = getTheme();

        const renderSideStat = (label, value, color, icon) => (
            <div className="flex flex-col items-center gap-1 h-full">
                <div className="text-[10px] font-bold text-white/50 tracking-wider flex items-center gap-1">{icon} {label}</div>
                <div className="w-4 flex-1 bg-black/40 rounded-full relative overflow-hidden border border-white/10 shadow-inner">
                    <div className={`absolute bottom-0 left-0 right-0 transition-all duration-1000 ${color}`} style={{ height: `${value}%` }}>
                        <div className="w-full h-full opacity-30 bg-[linear-gradient(transparent_50%,rgba(255,255,255,0.5)_50%)] bg-[length:100%_4px]"></div>
                    </div>
                </div>
                <div className="text-[9px] font-mono text-white/80">{Math.round(value)}%</div>
            </div>
        );

        return (
          <div className={`h-[100dvh] w-full flex flex-col items-center py-2 px-4 ${theme.bg} text-neutral-200 transition-colors duration-1000 overflow-hidden relative touch-none`}>
            
            {showIntro && (
              <div className="absolute inset-0 z-[100] flex items-center justify-center bg-black/80 backdrop-blur-sm p-6 animate-in fade-in duration-500">
                <div className={`max-w-xs w-full bg-neutral-900 border-2 ${theme.highlight.replace('text-', 'border-')} p-6 rounded-xl shadow-2xl text-center flex flex-col gap-4`}>
                    <h2 className={`text-xl font-bold ${theme.highlight} tracking-widest uppercase`}>Furettogotchi v2.0</h2>
                    <div className="text-xs text-neutral-400 font-mono space-y-2">
                      <p>Release: November 2024</p>
                      <div className="w-full h-px bg-white/10 my-2"></div>
                      <p className="text-white">NEXT UPDATE:</p>
                      <p className="text-lg font-bold text-yellow-400 animate-pulse">29 DEC 2025</p>
                      <p>(India Trip üáÆüá≥)</p>
                    </div>
                    <button onClick={() => setShowIntro(false)} className={`mt-4 py-3 px-6 bg-white text-black font-bold rounded hover:scale-105 active:scale-95 transition-all`}>
                      START
                    </button>
                </div>
              </div>
            )}
            
            <h1 className="text-lg md:text-3xl mb-1 text-center text-white/90 tracking-[0.2em] md:tracking-[0.3em] uppercase text-shadow-glow font-bold shrink-0">Furettogotchi <span className={theme.highlight}>Pixel</span></h1>
            
            <div className="flex-1 w-full max-w-[500px] flex flex-col items-center justify-center relative min-h-0">
              
              <div className="md:hidden w-full grid grid-cols-4 gap-2 mb-1 shrink-0 h-[60px]">
                 {renderSideStat("FAME", stats.hunger, "bg-green-500", <Utensils size={10}/>)}
                 {renderSideStat("HAPPY", stats.happiness, "bg-pink-500", <Heart size={10}/>)}
                 {renderSideStat("RELAX", stats.relax, "bg-blue-500", <Smile size={10}/>)}
                 {renderSideStat("CAFF√à", stats.caffeine, "bg-amber-600", <Coffee size={10}/>)}
              </div>

              <div className="hidden md:flex absolute left-[-80px] top-20 flex-col gap-4 p-3 bg-neutral-900/40 backdrop-blur-sm rounded-l-xl border-y border-l border-white/10 z-0">
                 {renderSideStat("FAME", stats.hunger, "bg-green-500", <Utensils size={10}/>)}
                 {renderSideStat("FELICIT√Ä", stats.happiness, "bg-pink-500", <Heart size={10}/>)}
              </div>
              <div className="hidden md:flex absolute right-[-80px] top-20 flex-col gap-4 p-3 bg-neutral-900/40 backdrop-blur-sm rounded-r-xl border-y border-r border-white/10 z-0">
                 {renderSideStat("RELAX", stats.relax, "bg-blue-500", <Smile size={10}/>)}
                 {renderSideStat("CAFF√à", stats.caffeine, "bg-amber-600", <Coffee size={10}/>)}
              </div>

              <div className={`relative flex-1 w-full max-h-[600px] md:h-[520px] md:aspect-auto md:flex-none rounded-[2rem] md:rounded-[50%_50%_45%_45%_/_55%_55%_40%_40%] border-[8px] md:border-[12px] flex flex-col items-center pt-4 md:pt-20 pb-2 md:pb-10 px-2 overflow-hidden transition-all duration-700 z-10 mb-12 md:mb-0 ${theme.shell} ${theme.shellShadow}`}>
                
                <div className={`w-full flex-1 min-h-0 relative flex flex-col items-center justify-center`}>
                    <div className={`aspect-square h-full max-h-full max-w-full md:w-[260px] md:aspect-auto md:h-[240px] rounded-xl border-4 relative p-3 flex flex-col justify-between transition-colors duration-700 ${theme.inner}`}>
                        <div className="absolute inset-0 pointer-events-none opacity-10 bg-[linear-gradient(transparent_50%,rgba(0,0,0,0.5)_50%)] bg-[length:100%_4px] z-20"></div>
                        
                        <div className="flex-1 relative flex flex-col items-center justify-center z-10 w-full h-full overflow-hidden">
                            <div className={`absolute top-1 left-1 right-1 flex justify-between opacity-60 ${theme.textMain} font-bold text-[10px] md:text-xs`}>
                                <div className="flex gap-1"><div className="absolute top-[-5px] right-[-5px] text-4xl md:text-5xl rotate-12 opacity-80 filter drop-shadow-md">{theme.flag}</div></div>
                                <div className="flex gap-1">
                                    {gameState === GameState.SLEEPING && <Moon size={12} />}
                                    {stats.caffeine < 20 && <Coffee size={12} className="animate-pulse" />}
                                    {stats.relax < 20 && <div className="text-[9px] animate-pulse">STRESS</div>}
                                </div>
                            </div>
                            {isMessageVisible && (
                                <div className={`absolute top-8 md:top-10 w-[95%] p-2 md:p-3 text-[9px] md:text-[10px] leading-tight text-center border-2 shadow-md z-30 rounded-md animate-in fade-in zoom-in duration-300 ${location === Location.VILLA_PANZA ? 'bg-pink-900 text-pink-100 border-pink-500' : 'bg-white text-black border-black'}`}>{message}</div>
                            )}
                            <div className={`w-32 h-32 md:w-40 md:h-40 relative transition-opacity ${menuState !== 'IDLE' ? 'opacity-20' : 'opacity-100'} ${location === Location.VILLA_PANZA ? 'grayscale contrast-125' : ''}`}>
                                <PixelFerret state={gameState} frame={frame} />
                                {stats.poopCount > 0 && <div className="absolute bottom-2 right-0 text-3xl animate-pulse">üí©</div>}
                                {interactionEmoji && (<div className="absolute inset-0 flex items-center justify-center pointer-events-none"><div className="text-5xl md:text-6xl animate-[bounce_1s_ease-in-out_infinite] opacity-90 filter drop-shadow-lg">{interactionEmoji}</div></div>)}
                            </div>
                            {menuState !== 'IDLE' && (
                                <div className="absolute inset-0 flex items-center justify-center z-40">
                                    <div className={`border-2 p-3 w-[85%] shadow-[4px_4px_0px_rgba(0,0,0,0.2)] ${location === Location.VILLA_PANZA ? 'bg-black border-pink-500' : 'bg-[#e0f0e0] border-black'}`}>
                                    <ul className={`text-xs md:text-sm font-bold ${theme.textMain}`}>
                                        {getCurrentMenuList().map((opt, i) => (
                                        <li key={opt} className={`px-2 py-1 mb-1 ${i === menuIndex ? (location === Location.VILLA_PANZA ? 'bg-pink-700 text-white' : 'bg-black text-white') : ''}`}>
                                            {i === menuIndex ? '> ' : '  '}{opt}
                                        </li>
                                        ))}
                                    </ul>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>

                <div className={`mt-1 md:mt-4 mb-1 font-bold text-sm md:text-xl tracking-[0.2em] opacity-50 shrink-0 ${location === Location.VILLA_PANZA ? 'text-pink-500 animate-pulse' : 'text-black/40'}`}>
                  {theme.branding}
                </div>

                <div className="flex justify-between w-[90%] md:w-[80%] md:max-w-[300px] mt-1 px-4 pb-1 shrink-0">
                  <div className="flex flex-col gap-2 md:gap-3 justify-center">
                     <button onClick={handleUp} className="w-10 h-10 md:w-12 md:h-12 bg-neutral-800 rounded flex items-center justify-center shadow-[0_4px_0_#1a1a1a] active:translate-y-1 active:shadow-none hover:bg-neutral-700 transition-all text-neutral-400 touch-manipulation"><ChevronUp size={20} /></button>
                     <button onClick={handleDown} className="w-10 h-10 md:w-12 md:h-12 bg-neutral-800 rounded flex items-center justify-center shadow-[0_4px_0_#1a1a1a] active:translate-y-1 active:shadow-none hover:bg-neutral-700 transition-all text-neutral-400 touch-manipulation"><ChevronDown size={20} /></button>
                  </div>
                  <div className="flex gap-4 md:gap-6 items-end mb-1 md:rotate-[-10deg]">
                     <div className="flex flex-col items-center gap-1 md:translate-y-6"><button onClick={handleBack} className="w-12 h-12 md:w-14 md:h-14 bg-red-600 rounded-full shadow-[0_5px_0_#991b1b] active:shadow-none active:translate-y-1 active:bg-red-700 transition-all flex items-center justify-center text-red-900 font-bold text-lg touch-manipulation">B</button></div>
                     <div className="flex flex-col items-center gap-1"><button onClick={handleConfirm} className="w-12 h-12 md:w-14 md:h-14 bg-blue-600 rounded-full shadow-[0_5px_0_#1e40af] active:shadow-none active:translate-y-1 active:bg-blue-700 transition-all flex items-center justify-center text-blue-900 font-bold text-lg touch-manipulation">A</button></div>
                  </div>
                </div>
              </div>
            </div>
            
            <MusicPlayer playlist={getCurrentPlaylist()} theme={theme} />
          </div>
        );
      };

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
